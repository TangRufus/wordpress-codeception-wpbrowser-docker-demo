version: '3.8'

x-db-environment: &x-db-environment
  MYSQL_RANDOM_ROOT_PASSWORD: "true"
  MYSQL_DATABASE: ${MYSQL_DATABASE}
  MYSQL_USER: ${MYSQL_USER}
  MYSQL_PASSWORD: ${MYSQL_PASSWORD}

x-wordpress-environment: &x-wordpress-environment
  WORDPRESS_DEBUG: "true"
  WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
  WORDPRESS_DB_USER: ${MYSQL_USER}
  WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}

services:
  composer:
    image: cimg/php:${PHP_VERSION}
    restart: "no"
    command: bash
    volumes:
      - ./:/home/circleci/project

  wordpress:
    image: wordpress:${WP_VERSION}-php${PHP_VERSION}
    restart: unless-stopped
    environment: &wordpress-environment
      <<: *x-wordpress-environment
      WORDPRESS_DB_HOST: db
    ports:
      - "${WEB_PUBLISHED_PORT}:80"
    volumes: &wordpress-volumes
      - ./:/var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}:cached
      - /var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}/.git
      - wordpress:/var/www/html
    depends_on:
      - db
    networks:
      - workspace

  wp-cli:
    image: wordpress:cli-php${PHP_VERSION}
    restart: "no"
    command: bash
    environment: *wordpress-environment
    volumes: *wordpress-volumes
    working_dir: /var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}
    depends_on:
      - db
      - wordpress
    networks:
      - workspace

  db:
    image: mariadb:${MARIADB_VERSION}
    restart: unless-stopped
    environment: *x-db-environment
    ports:
      - "${DATABASE_PUBLISHED_PORT}:3306"
    volumes:
      - wordpress-db:/var/lib/mysql:delegated
    networks:
      - workspace

  wordpress-test:
    image: wordpress:${WP_VERSION}-php${PHP_VERSION}
    restart: unless-stopped
    environment:
      <<: *x-wordpress-environment
      WORDPRESS_DB_HOST: db-test
    volumes:
      - ./:/var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}
      - wordpress-test:/var/www/html
    depends_on:
      - db-test
    networks:
      - test

  test:
    image: cimg/php:${PHP_VERSION}
    entrypoint: vendor/bin/codecept run
    restart: "no"
    depends_on:
      - wordpress-test
      - db-test
      - chrome
    environment:
      <<: *x-db-environment
      MYSQL_HOST: db-test
      SELENIUM_HOST: chrome
      SELENIUM_BROWSER: chrome
      TEST_SITE_WP_URL: http://wordpress-test
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
      WP_ROOT_FOLDER: ${WP_ROOT_FOLDER}
      TEST_TABLE_PREFIX: ${TEST_TABLE_PREFIX}
      TEST_SITE_WP_DOMAIN: ${TEST_SITE_WP_DOMAIN}
      TEST_SITE_ADMIN_EMAIL: ${TEST_SITE_ADMIN_EMAIL}
      TEST_SITE_WP_ADMIN_PATH: ${TEST_SITE_WP_ADMIN_PATH}
      TEST_SITE_ADMIN_USERNAME: ${TEST_SITE_ADMIN_USERNAME}
      TEST_SITE_ADMIN_PASSWORD: ${TEST_SITE_ADMIN_PASSWORD}
    working_dir: /var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}
    volumes:
      - ./:/var/www/html/wp-content/plugins/${COMPOSE_PROJECT_NAME}
      - wordpress-test:/var/www/html
    networks:
      - test

  chrome:
    image: selenium/standalone-chrome:4
    restart: unless-stopped
    shm_size: '2gb'
    networks:
      - test

  db-test:
    image: circleci/mariadb:${MARIADB_VERSION}-ram
    restart: unless-stopped
    shm_size: '512mb'
    environment: *x-db-environment
    networks:
      - test

networks:
  workspace:
  test:

volumes:
  wordpress:
    name: ${COMPOSE_PROJECT_NAME}-wordpress
    external: true
  wordpress-db:
    name: ${COMPOSE_PROJECT_NAME}-wordpress-db
    external: true
  wordpress-test:
    name: ${COMPOSE_PROJECT_NAME}-wordpress-test
